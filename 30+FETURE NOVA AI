"""
NOVA AI: Full Personal Assistant with 30+ Features
Author: [shah tishhya]
Version: 2.0 (API Key Secured)

SETUP INSTRUCTIONS:
1. Create a .env file in the same directory with:
   ACCUWEATHER_API_KEY=your_api_key_here
   NEWSDATA_API_KEY=your_api_key_here
   WOLFRAMALPHA_API_KEY=your_api_key_here

2. Install required packages:
   pip install opencv-python speechrecognition pyttsx3 pywhatkit wikipedia requests \
   beautifulsoup4 python-dotenv psutil pyautogui pyperclip pyjokes wolframalpha speedtest-cli

3. Run the script:
   python nova_ai_clean.py
"""
# NOVA AI â€“ Real-Time 
# Weather (No API, No Signup, Free)

import cv2
import os
import speech_recognition as sr
import pyttsx3
import pywhatkit as pwk
import wikipedia
import datetime
import time
import threading
import webbrowser
import pyjokes
import psutil
import pyautogui
import platform
import speedtest
import requests
from bs4 import BeautifulSoup
import urllib.parse
from requests.exceptions import RequestException, ConnectTimeout

# ---------------- TEXT TO SPEECH ----------------
engine = pyttsx3.init()
engine.setProperty("rate", 170)
voices = engine.getProperty("voices")
engine.setProperty("voice", voices[1].id)

def speak(text):
    print("AI:", text)
    engine.say(text)
    engine.runAndWait()

# ---------------- SPEECH RECOGNITION ----------------
recognizer = sr.Recognizer()

def take_command():
    with sr.Microphone() as source:
        print("Listening...")
        recognizer.adjust_for_ambient_noise(source)
        audio = recognizer.listen(source)
    try:
        command = recognizer.recognize_google(audio, language="en-in")
        print("You:", command)
        return command.lower()
    except:
        speak("Sorry, I didn't understand.")
        return ""

# ---------------- BASIC FEATURES ----------------
def tell_time():
    speak(datetime.datetime.now().strftime("Time is %I:%M %p"))

def tell_date():
    speak(datetime.datetime.now().strftime("Today is %A %d %B %Y"))

def search_google(query):
    webbrowser.open(f"https://www.google.com/search?q={query}")
    speak("Searching on Google")

def play_song(song):
    speak(f"Playing {song}")
    pwk.playonyt(song)

def stop_song():
    pyautogui.press("space")
    speak("Song stopped")

def tell_about(topic):
    try:
        speak(wikipedia.summary(topic, sentences=2))
    except:
        speak("Information not found")

# ---------------- REAL-TIME WEATHER (NO API) ----------------
def get_weather(city):
    # Prepare city (URL-encode). If empty, wttr.in will use IP-based location.
    if city:
        city_enc = urllib.parse.quote_plus(city)
    else:
        city_enc = ""

    url = f"https://wttr.in/{city_enc}?format=3"

    # Try a few times with exponential backoff
    for attempt in range(1, 4):
        try:
            response = requests.get(url, timeout=8 + (attempt - 1) * 2)
            response.raise_for_status()
            weather = response.text.strip()
            speak(f"Current weather: {weather}")
            return

        except ConnectTimeout as e:
            print(f"Weather timeout (attempt {attempt}):", e)
            # On first timeout, try plain HTTP fallback once
            if attempt == 1:
                try:
                    url_http = url.replace("https://", "http://")
                    response = requests.get(url_http, timeout=8)
                    response.raise_for_status()
                    weather = response.text.strip()
                    speak(f"Current weather: {weather}")
                    return
                except RequestException:
                    pass
            time.sleep(attempt)

        except RequestException as e:
            print(f"Weather request error (attempt {attempt}):", e)
            time.sleep(attempt)

    # All attempts failed
    speak("Unable to fetch weather right now. Please check your internet connection.")


# ---------------- SYSTEM FEATURES ----------------
def tell_joke():
    speak(pyjokes.get_joke())

def system_info():
    info = platform.uname()
    speak(f"System {info.system} with processor {info.processor}")

def cpu_stats():
    speak(f"CPU usage is {psutil.cpu_percent()} percent")

def battery_status():
    battery = psutil.sensors_battery()
    speak(f"Battery is at {battery.percent} percent")

def internet_speed():
    try:
        st = speedtest.Speedtest()
        speak(f"Download speed {round(st.download()/1e6,2)} Mbps")
    except:
        speak("Speed test not available")

def screenshot():
    img = pyautogui.screenshot()
    img.save("screenshot.png")
    speak("Screenshot saved")

# ---------------- SYSTEM CONTROL ----------------
def shutdown():
    speak("Shutting down system")
    os.system("shutdown /s /t 1")

def restart():
    speak("Restarting system")
    os.system("shutdown /r /t 1")

def lock_system():
    speak("Locking system")
    os.system("rundll32.exe user32.dll,LockWorkStation")

def volume_up():
    for _ in range(5):
        pyautogui.press("volumeup")

def volume_down():
    for _ in range(5):
        pyautogui.press("volumedown")

def mute_volume():
    pyautogui.press("volumemute")

# ---------------- MAIN LOOP ----------------
if __name__ == "__main__":
    speak("Hello, I am Nova AI. How can I help you?")

    while True:
        query = take_command()

        if "time" in query:
            tell_time()

        elif "date" in query:
            tell_date()

        elif "search" in query:
            search_google(query.replace("search", ""))

        elif "play" in query:
            play_song(query.replace("play", ""))

        elif "stop" in query:
            stop_song()

        elif "tell me about" in query:
            tell_about(query.replace("tell me about", ""))

        elif "weather" in query:
            speak("Which city?")
            city = take_command()
            get_weather(city)

        elif "joke" in query:
            tell_joke()

        elif "system info" in query:
            system_info()

        elif "cpu" in query:
            cpu_stats()

        elif "battery" in query:
            battery_status()

        elif "speed" in query:
            internet_speed()

        elif "screenshot" in query:
            screenshot()

        elif "shutdown" in query:
            shutdown()

        elif "restart" in query:
            restart()

        elif "lock" in query:
            lock_system()

        elif "volume up" in query:
            volume_up()

        elif "volume down" in query:
            volume_down()

        elif "mute" in query:
            mute_volume()
        elif "thank you" in query:
            speak("You're welcome")
        elif "exit" in query or "bye" in query:
            speak("Goodbye")
       
            break

        else:
            speak("Please say again")
